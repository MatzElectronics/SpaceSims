<html>

<head>
    <title>Spheres</title>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            background-color: #000;
            overflow: hidden;
            font-family: 'Ubuntu', sans-serif;
        }

        h3 {
            font-weight: 700;
            margin-top: 0px;
        }

        canvas {
            width: 100%;
            height: 100%
        }

        #simulation {
            height: 100vh;
            width: 100vw;
        }

        .moon {
            fill: rgba(0, 0, 0, 0.85);
            stroke: rgba(0, 0, 0, 0.85);
            stroke-width: 2;
        }

        #moonbox {
            background-color: black;
        }

        #month-name {
            display: inline-block;
            width: 85px;
            text-align: center;
        }

        .control-panel, .control-subpanel {
            z-index: 1000;
            background: rgba(0, 0, 64, 0.7);
            padding: 20px;
            color: white;
            border-radius: 10px;
            border: 2px solid white;
        }

        .control-panel, .control-group {
            position: absolute;
        }

        #controls-month {
            top: 20px;
            left: 20px;
        }

        #controls-speed {
            top: 20px;
            right: 20px;
        }

        #slider-container {
            margin: 0;
        }

        #controls-subpanel {
            bottom: 20px;
            left: 0px;
            display: flex;
            width: calc(100vw - 244px);
        }

        #controls-subpanel > div {
            margin-left: 20px;
        }

        #moon-phase-display {
            position: absolute;
            z-index: 1000;
            bottom: 20px;
            right: 20px;
            border-radius: 10px;
            border: 2px solid white;
        }

        #moon-phase-display>svg {
            border-radius: 10px;
        }
    </style>
</head>

<body>

    <div id="simulation"></div>
    <div id="moon-phase-display">
        <svg id="moonbox" width="200px" height="200px" viewBox="0 0 170 170" xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink">
            <defs>
                <pattern id="img1" patternUnits="userSpaceOnUse" width="400" height="400">
                    <image href="../images/moon.jpg" x="15" y="15" width="140" height="140" />
                </pattern>
            </defs>
            <filter id="blurEdge">
                <feGaussianBlur in="SourceGraphic" stdDeviation="3" />
            </filter>
            <rect fill="url(#img1)" x="10" y="10" width="150" height="150" />
            <path class="moon" filter="url(#blurEdge)" />
        </svg>
    </div>
    <div id="controls">
        <div id="controls-month" class="control-panel">
            <h3>Month:</h3>
            <button onclick="setMonthAngle(Math.round(monthOffset * 180 / Math.PI) - 30);">&#9668;</button>
            <span id="month-name">January</span>
            <button onclick="setMonthAngle(Math.round(monthOffset * 180 / Math.PI) + 30);">&#9658;</button>
        </div>

        <div id="controls-speed" class="control-panel">
            <h3>Speed:</h3>
            <div id="slider-container">
                <input id="sim-speed-slider" type="range" min="-6" max="6" value="1" step="1" onchange="simSpeed = parseInt(this.value * 1.5);"><br>
            </div>
            Reverse&nbsp;&nbsp;
            <button onclick="simSpeed = 0; document.getElementById('sim-speed-slider').value = 0;">Stop</button>
            &nbsp;&nbsp;Forward
        </div>
        <div id="controls-subpanel" class="control-group">
            <div id="controls-earth" class="control-subpanel">
                <h3>The Earth:</h3>
                <input type="checkbox" id="earth-axis" name="earth-axis" checked
                    onchange="earthAxis.visible = !earthAxis.visible">
                <label for="earth-axis">Earth's axis</label>
                <br>
                <input type="checkbox" id="earth-orbit" name="earth-orbit" checked
                    onchange="earthOrbit.visible = !earthOrbit.visible">
                <label for="earth-orbit">Earth's orbit</label>
                <br>
                <input type="checkbox" id="earth-plane" name="earth-plane"
                    onchange="earthPlane.visible = !earthPlane.visible">
                <label for="earth-plane">Earth's plane of orbit</label>
            </div>
            <div id="controls-moon" class="control-subpanel">
                <h3>The Moon:</h3>
                <input type="checkbox" id="moon-axis" name="moon-axis" checked
                    onchange="moonAxis.visible = !moonAxis.visible">
                <label for="moon-axis">Moon's axis</label>
                <br>
                <input type="checkbox" id="moon-orbit" name="moon-orbit" checked
                    onchange="moonOrbit.visible = !moonOrbit.visible">
                <label for="moon-orbit">Moon's orbit</label>
                <br>
                <input type="checkbox" id="moon-plane" name="moon-plane"
                    onchange="moonPlane.visible = !moonPlane.visible">
                <label for="moon-plane">Moon's plane of orbit</label>
            </div>
            <div id="controls-sun" class="control-subpanel">
                <h3>Sunlight:</h3>
                <input type="checkbox" id="moon-axis" name="moon-axis" checked
                    onchange="sunRays.visible = !sunRays.visible">
                <label for="sun-rays">Sun's Rays:</label>
                <br>
                <input type="checkbox" id="moon-orbit" name="moon-orbit" checked
                    onchange="">
                <label for="earth-shadows">Earth's Shadows</label>
                <br>
                <input type="checkbox" id="moon-plane" name="moon-plane"
                    onchange="">
                <label for="moon-shadows">Moon's Shadows</label>
            </div>
        </div>
    </div>
    <script src="../lib/three.min.js"></script>
    <script src="../lib/orbit_controls.js"></script>
    <script>
        var simElement = document.getElementById('simulation');
        var simSpeed = 1;
        var moonOrbitRadius = 30; // 60
        var moonOrbitOffset = 15;
        var moonSize = 4; // 1.8
        var monthOffset = 0; //90 * (Math.PI / 180);
        var eclipses = true;

        //Camera, scene, and renderer

        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(45, simElement.offsetWidth / simElement.offsetHeight, 1, 2000);
        scene.add(camera);
        camera.position.set(0, 0, 140);

        var renderer = new THREE.WebGLRenderer({
            antialias: true
        });
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; //THREE.PCFShadowMap; 

        renderer.setSize(simElement.offsetWidth, simElement.offsetHeight);
        simElement.appendChild(renderer.domElement);

        //Orbit Controls
        var orbitControls = new THREE.OrbitControls(camera, renderer.domElement);

        //Lights
        var ambientLight = new THREE.AmbientLight(0x202020, 0.6);
        scene.add(ambientLight);

        var spotLight = new THREE.DirectionalLight(0xffffff, 1);
        spotLight.castShadow = eclipses; // default false
        spotLight.position.set(0, 0, 400);
        if (eclipses) {
            spotLight.shadow.mapSize.width = 1024;
            spotLight.shadow.mapSize.height = 1024;
            spotLight.shadow.camera.near = 2; // default
            spotLight.shadow.camera.far = 1500; // 
            spotLight.shadow.camera.top = 100; // 
            spotLight.shadow.camera.left = -100; // 
            spotLight.shadow.camera.right = 100; // 
            spotLight.shadow.camera.bottom = -100; // 
        }
        scene.add(spotLight);

        var spotLight2 = new THREE.DirectionalLight(0xffffff, 0.6);
        spotLight2.copy(spotLight);
        spotLight.position.set(0, 0, 600);
        scene.add(spotLight2);


        //Objects (We build a mesh using a geometry and a material)

        //Earth
        var earth = new THREE.Group();

        var earthPlanetGeometry = new THREE.SphereGeometry(10, 50, 50);
        var earthPlanetMaterial = new THREE.MeshPhongMaterial({
            map: new THREE.TextureLoader().load("../images/EarthNoClouds.jpg"),
            color: 0xf2f2f2,
            specular: 0xaaaaaa,
            shininess: 1.2
        });
        var earthPlanet = new THREE.Mesh(earthPlanetGeometry, earthPlanetMaterial);
        earthPlanet.receiveShadow = eclipses;
        earthPlanet.castShadow = eclipses;
        earth.add(earthPlanet);

        //Clouds
        var cloudGeometry = new THREE.SphereGeometry(10.3, 50, 50);
        var cloudMaterial = new THREE.MeshLambertMaterial({
            map: new THREE.TextureLoader().load("../images/clouds_2.jpg"),
            transparent: true,
            opacity: 0.1
        });
        var clouds = new THREE.Mesh(cloudGeometry, cloudMaterial);
        clouds.castShadow = false; //default is false
        earth.add(clouds);

        // Earth - Axis
        var earthAxisGeometry = new THREE.CylinderGeometry(0.1, 0.1, 30, 16);
        var earthAxisMaterial = new THREE.MeshLambertMaterial({
            color: 0x00ffff,
            emissive: 0x00ffff,
        });
        var earthAxis = new THREE.Mesh(earthAxisGeometry, earthAxisMaterial);
        earth.add(earthAxis);

        // Earth - Orbital Plane
        var earthPlaneGeometry = new THREE.CylinderGeometry(2000, 2000, 0.1, 720);
        var earthPlaneMaterial = new THREE.MeshLambertMaterial({
            color: 0x00ffff,
            emissive: 0x00ffff,
            opacity: 0.1,
            transparent: true,
        });
        var earthPlane = new THREE.Mesh(earthPlaneGeometry, earthPlaneMaterial);
        earthPlane.position.z = 2000;
        scene.add(earthPlane);

        // Earth - Orbit
        var earthOrbitGeometry = new THREE.TorusGeometry(2000, 0.15, 16, 1000);
        var earthOrbitMaterial = new THREE.MeshLambertMaterial({
            color: 0x00ffff,
            side: THREE.DoubleSide,
            emissive: 0x00ffff,
            opacity: 0.4,
            transparent: true,
        });
        var earthOrbit = new THREE.Mesh(earthOrbitGeometry, earthOrbitMaterial);
        earthOrbit.position.z = 2000;
        earthOrbit.rotation.x = Math.PI / 2;
        scene.add(earthOrbit);



        // Sun rays
        var sunRays = new THREE.Group();
        var sunRayGeometry = new THREE.CylinderGeometry(0.5, 0.5, 30, 4);
        var sunRayMaterial = new THREE.MeshLambertMaterial({
            color: 0xffff88,
            emissive: 0xffff88,
            opacity: 0.4,
            transparent: true
        });
        var sunRayArray = [];
        for (var ii = 0; ii < 10; ii++) {
            sunRayArray.push(new THREE.Mesh(sunRayGeometry, sunRayMaterial));
            sunRayArray[ii].rotation.x = Math.PI / 2;
            sunRayArray[ii].position.z = 12;
            sunRayArray[ii].position.y = 9 - ii * 2;
            sunRayArray[ii].rotation.y = Math.PI / 4;
            sunRays.add(sunRayArray[ii]);
        }

        scene.add(earth);
        scene.add(sunRays);


        //Sun
        var sunGeometry = new THREE.SphereGeometry(10, 50, 50);
        var sunMaterial = new THREE.MeshLambertMaterial({
            map: new THREE.TextureLoader().load("../textures/sun_texture.jpg"),
            emissive: 0xffffbb
        });
        var sun = new THREE.Mesh(sunGeometry, sunMaterial);
        sun.position.set(0, 0, 1000);
        sun.castShadow = false; //default is false
        sun.receiveShadow = false;
        scene.add(sun);

        //Stars
        var starGeometry = new THREE.SphereGeometry(1000, 50, 50);
        var starMaterial = new THREE.MeshBasicMaterial({
            map: new THREE.TextureLoader().load("../images/galaxy_starfield.png"),
            side: THREE.DoubleSide,
        });
        var starField = new THREE.Mesh(starGeometry, starMaterial);
        scene.add(starField);

        //Moon 
        var moon = new THREE.Group();
        var moonGeometry = new THREE.SphereGeometry(moonSize, 50, 50);
        var moonMaterial = new THREE.MeshLambertMaterial({
            map: new THREE.TextureLoader().load("../images/moon_texture2.jpg"),
        });
        var moonMoon = new THREE.Mesh(moonGeometry, moonMaterial);
        moonMoon.receiveShadow = eclipses;
        moonMoon.castShadow = false;
        moon.add(moonMoon);

        // Moon - Orbit
        var moonOrbitGeometry = new THREE.TorusGeometry(moonOrbitRadius, .1, 16, 360);
        var moonOrbitMaterial = new THREE.MeshLambertMaterial({
            color: 0x00ff00,
            side: THREE.DoubleSide,
            emissive: 0x00ff00,
            opacity: 0.4,
            transparent: true,
        });
        var moonOrbit = new THREE.Mesh(moonOrbitGeometry, moonOrbitMaterial);
        scene.add(moonOrbit);

        // Moon - Orbital Plane
        var moonPlaneGeometry = new THREE.CylinderGeometry(moonOrbitRadius, moonOrbitRadius, 0.1, 360);
        var moonPlaneMaterial = new THREE.MeshLambertMaterial({
            color: 0x00ff00,
            emissive: 0x00ff00,
            opacity: 0.1,
            transparent: true,
        });
        var moonPlane = new THREE.Mesh(moonPlaneGeometry, moonPlaneMaterial);
        scene.add(moonPlane);

        if (eclipses) {
            //Moon - Core (for making a smaller shadow)
            var moonCoreGeometry = new THREE.SphereGeometry(moonSize / 3.5, 40, 40);
            var moonCoreMaterial = new THREE.MeshBasicMaterial({
                color: 0xffffff
            });
            var moonCore = new THREE.Mesh(moonCoreGeometry, moonCoreMaterial);
            moonCore.receiveShadow = false;
            moonCore.castShadow = true;
            moon.add(moonCore);
        }

        // Moon - Axis
        var moonAxisGeometry = new THREE.CylinderGeometry(0.1, 0.1, moonSize * 3, 16);
        var moonAxisMaterial = new THREE.MeshLambertMaterial({
            color: 0x00ff00,
            emissive: 0x00ff00,
        });
        var moonAxis = new THREE.Mesh(moonAxisGeometry, moonAxisMaterial);
        moonAxis.rotation.z = -moonOrbitOffset * (Math.PI / 180); // moonOrbitOffset degrees (exaggerated);
        moon.add(moonAxis);

        moon.rotation.y = Math.PI; // Turn the correct face toward the earth
        scene.add(moon);

        if (eclipses) {
            //Moon Shader (for making the penumbra shadow)
            var moonShaderGeometry = new THREE.SphereGeometry(moonSize * 1.25, 40, 40);
            var moonShaderMaterial = new THREE.MeshBasicMaterial({
                color: 0x000000,
                opacity: 0.001,
                transparent: true,
            });
            var moonShader = new THREE.Mesh(moonShaderGeometry, moonShaderMaterial);
            moonShader.receiveShadow = false;
            moonShader.castShadow = true;
            scene.add(moonShader);
        }

        //Camera vector
        var earthVec = new THREE.Vector3(0, 0, 0);

        var theta = 0;

        earthPlane.visible = false;
        moonPlane.visible = false;

        function setMonthAngle(offsetAngle) {
            if (offsetAngle === 0) {
                monthOffset = 0;
            } else if (offsetAngle) {
                offsetAngle = (offsetAngle >= 360 ? offsetAngle - 360 : (offsetAngle < 0 ? offsetAngle + 360 :
                    offsetAngle));
                monthOffset = offsetAngle * Math.PI / 180;
            } else {
                offsetAngle = 0;
                monthOffset = 0;
            }

            var monthNames = ['April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December',
                'January', 'February', 'March'
            ];
            document.getElementById('month-name').innerHTML = monthNames[(offsetAngle) / 30];

            earth.rotation.x = 23.5 * (Math.PI / 180) * Math.sin(monthOffset);
            earth.rotation.z = 23.5 * (Math.PI / 180) * Math.cos(monthOffset);

            moonPlane.rotation.z = moonOrbitOffset * (Math.PI / 180) * Math.cos(-
                monthOffset); // moonOrbitOffset degrees (exaggerated);
            moonPlane.rotation.x = moonOrbitOffset * (Math.PI / 180) * Math.sin(-monthOffset);
            moonOrbit.rotation.y = moonOrbitOffset * (Math.PI / 180) * Math.cos(-
                monthOffset); // moonOrbitOffset degrees (exaggerated);
            moonOrbit.rotation.x = Math.PI / 2 + moonOrbitOffset * (Math.PI / 180) * Math.sin(-monthOffset);
        }

        setMonthAngle();

        //Render loop
        var render = function () {
            var dTheta = simSpeed * 0.025 * Math.PI / 180; // 0.5 degrees/step

            earthPlanet.rotation.y += simSpeed * .017;
            clouds.rotation.y += simSpeed * .01;

            //Moon orbit        
            theta -= dTheta;
            if (theta < 0) {
                theta += Math.PI * 2;
            }

            var phaseRadians = (theta + Math.PI / 2) / (Math.PI * 2);
            drawPhase(1 - phaseRadians + Math.floor(phaseRadians));

            moon.position.x = moonOrbitRadius * Math.cos(theta) *
                0.96; // Not sure why these fudge factors are needed...stupid floating point rounding garbage probably...
            moon.position.z = moonOrbitRadius * Math.sin(theta) * 0.99;
            moon.position.y = moonOrbitRadius * Math.cos(theta - monthOffset) * moonOrbitOffset * (Math.PI /
                180); // moonOrbitOffset degrees (exaggerated);

            moonShader.position.x = moon.position.x;
            moonShader.position.z = 500;
            moonShader.position.y = moon.position.y;

            var shadowCondition = (moon.position.z > 0);
            moonMoon.receiveShadow = !shadowCondition;
            moonShader.castShadow = shadowCondition;

            moon.rotation.y += dTheta;
            moonAxis.rotation.y -= dTheta; // remove rotation from axis marker


            camera.lookAt(earthVec);
            renderer.render(scene, camera);
            requestAnimationFrame(render);
        };
        render();

        function drawPhase(phase) {
            var sweep = [];
            var mag;
            if (phase <= 0.25) {
                sweep = [1, 0];
                mag = 20 - 20 * phase * 4;
            } else if (phase <= 0.50) {
                sweep = [0, 0];
                mag = 20 * (phase - 0.25) * 4;
            } else if (phase <= 0.75) {
                sweep = [1, 1];
                mag = 20 - 20 * (phase - 0.50) * 4;
            } else if (phase <= 1) {
                sweep = [0, 1];
                mag = 20 * (phase - 0.75) * 4;
            }
            var d = "m85,10 a" + mag + ",20 0 1," + sweep[0] + " 0,150 a20,20 0 1," + sweep[1] + " 0,-150";
            var path = document.querySelector('.moon');
            path.setAttribute('d', d);
        }
    </script>
</body>

</html>